import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{r as i}from"./index.DH0ko44-.js";import{s as a}from"./supabaseClient.-23kbNNv.js";import{M as f}from"./MessageBox.YTdtkdn0.js";function x({selected:d,onSelect:o}){const[s,u]=i.useState([]);return i.useEffect(()=>{a.from("tickets").select("*").then(t=>{!t.error&&t.data&&u(t.data)});const n=a.channel("tickets").on("postgres_changes",{event:"*",schema:"public",table:"tickets"},t=>{u(l=>{switch(t.eventType){case"INSERT":return[...l,t.new];case"UPDATE":return l.map(r=>r.id===t.new.id?t.new:r);case"DELETE":return l.filter(r=>r.id!==t.old.id);default:return l}})}).subscribe();return()=>void a.removeChannel(n)},[]),e.jsx("aside",{className:"w-1/4 border-r overflow-y-auto h-full",children:e.jsx("ul",{children:s.map(n=>e.jsx("li",{children:e.jsxs("button",{onClick:()=>o(n),className:`w-full text-left p-4 hover:bg-gray-100 ${d?.id===n.id?"bg-blue-100":""}`,children:[e.jsx("div",{className:"font-semibold",children:n.name}),e.jsx("div",{className:"text-sm",children:n.issue}),e.jsx("div",{className:"text-xs text-gray-500",children:n.status})]})},n.id))})})}function p(){const[d,o]=i.useState([]),[s,u]=i.useState(null),[n,t]=i.useState([]);i.useEffect(()=>{a.from("tickets").select("*").then(({data:c})=>{c&&(o(c),u(c[0]??null))});const r=a.channel("tickets").on("postgres_changes",{event:"INSERT",schema:"public",table:"tickets"},c=>o(m=>[...m,c.new])).subscribe();return()=>r.unsubscribe()},[]),i.useEffect(()=>{if(!s)return;a.from("messages").select("*").eq("ticket_id",s.id).order("created_at",{ascending:!0}).then(({data:c})=>c&&t(c));const r=a.channel(`messages-${s.id}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`ticket_id=eq.${s.id}`},c=>t(m=>[...m,c.new])).subscribe();return()=>r.unsubscribe()},[s]);const l=r=>t(c=>[...c,r]);return e.jsxs("div",{className:"flex h-full",children:[e.jsx(x,{tickets:d,selected:s,onSelect:u}),e.jsx("div",{className:"flex-1 flex flex-col",children:s?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"border-b p-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:s.name}),e.jsx("p",{className:"text-sm",children:`${s.issue} â€“ ${s.status}`})]}),e.jsx(f,{ticketId:s.id,messages:n,appendMessage:l,senderType:"support"})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-gray-500",children:"No tickets yet."})})]})}export{p as default};
