---
import AgentLogs from '@/react-components/AgentLogs.tsx';
import { supabase } from '@/lib/supabaseClient';

const url = new URL(Astro.request.url);
const agentId = url.searchParams.get('agentId');

let groupedMessages = [];
let agentName = '';

if (agentId) {
  const { data: tickets, error: ticketErr } = await supabase
    .from('tickets')
    .select('id, status, issue, customer:customer_id(name)')
    .eq('agent_id', agentId);

  if (!ticketErr && tickets?.length > 0) {
    const ticketIds = tickets.map(t => t.id);

    const { data: messages, error: msgError } = await supabase
      .from('messages')
      .select('id, ticket_id, sender, content, created_at')
      .in('ticket_id', ticketIds)
      .order('created_at', { ascending: true });

    groupedMessages = tickets.map(ticket => ({
      ticketId: ticket.id,
      customerName: ticket.customer?.name || 'Unknown',
      issue: ticket.issue,
      status: ticket.status,
      messages: (messages || []).filter(msg => msg.ticket_id === ticket.id)
    }));
  }

  const { data: agent, error: agentErr } = await supabase
    .from('agents')
    .select('name')
    .eq('id', agentId)
    .single();

  agentName = agent?.name || '';
}
---

<html>
  <head>
    <title>Agent Logs</title>
  </head>
  <body>
    <AgentLogs
      agentName={agentName}
      agentId={agentId}
      groupedMessages={groupedMessages}
      client:only="react"
    />
  </body>
</html>
