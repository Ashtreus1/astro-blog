---
import AgentLogs from '@/react-components/AgentLogs.tsx'; // adjust path
import { supabase } from '@/lib/supabaseClient';

const url = new URL(Astro.request.url);
const agentId = url.searchParams.get('agentId');

let groupedMessages = [];
let agentName = '';

if (agentId) {
  const { data: tickets, error: ticketErr } = await supabase
    .from('tickets')
    .select('id, customer:customer_id(name), status, created_at')
    .eq('agent_id', agentId);

  const ticketIds = tickets?.map((t) => t.id) || [];

  const { data: messages, error: msgError } = await supabase
    .from('messages')
    .select('id, ticket_id, sender, content, created_at')
    .in('ticket_id', ticketIds)
    .order('created_at', { ascending: true });

  const grouped = ticketIds.map((id) => ({
    ticket: tickets.find((t) => t.id === id),
    messages: messages?.filter((m) => m.ticket_id === id) || [],
  }));

  groupedMessages = grouped;

  const { data: agent, error: agentErr } = await supabase
    .from('agents')
    .select('name')
    .eq('id', agentId)
    .single();

  agentName = agent?.name || '';
}
---

<html>
  <head>
    <title>Agent Logs</title>
  </head>
  <body>
    <AgentLogs agentName={agentName} agentId={agentId} groupedMessages={groupedMessages} client:only="react" />
  </body>
</html>
